<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ospital ng Makati – Antimicrobial Request System (IDS Module)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <style>
    :root {
      --osmak-green: #009a3e;
      --osmak-green-dark: #007530;
      --osmak-red: #dc2626;
      --amber: #f59e0b;
      --amber-dark: #b45309;
      --bg-main: #f5f5f5;
      --bg-card: #ffffff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #d1d5db;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
    }

    /* HEADER (sticky) */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: var(--osmak-green);
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    header img {
      height: 48px;
    }
    header h1 {
      margin: 0;
      font-size: 1.05rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    header small {
      display: block;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.5rem 1rem 2rem;
    }

    /* TABS (sticky below header) */
    .tabs {
      position: sticky;
      top: 72px;
      z-index: 90;
      background: var(--bg-main);
      padding: 0.5rem 0 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .tab-btn {
      background: #fff;
      border: 1px solid var(--border);
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .tab-btn.active {
      background: var(--osmak-green);
      color: #fff;
      border-color: var(--osmak-green-dark);
    }

    /* SECTIONS */
    .section {
      display: none;
      margin-top: 0.75rem;
    }
    .section.active {
      display: block;
    }

    /* FILTER ROWS */
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-bottom: 0.7rem;
    }
    .filter-row input,
    .filter-row select {
      padding: 0.45rem;
      border-radius: 0.4rem;
      border: 1px solid var(--border);
      font-size: 0.9rem;
      background: #fff;
    }

    /* PENDING CARDS */
    .card {
      background: var(--bg-card);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      padding: 0.85rem 0.9rem;
      margin-bottom: 0.8rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.04);
      cursor: pointer;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }
    .card-title {
      font-weight: 600;
      font-size: 0.95rem;
    }
    .card-body-line {
      font-size: 0.85rem;
      margin: 0.12rem 0;
    }

    /* LIST VIEW (Approved / Rejected tabs) */
    .list-container {
      border-radius: 0.6rem;
      border: 1px solid var(--border);
      background: #fff;
      max-height: 520px;
      overflow-y: auto;
    }
    .list-item {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.7rem 0.9rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .list-item:last-child {
      border-bottom: none;
    }
    .list-left {
      font-size: 0.85rem;
    }
    .list-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-size: 0.8rem;
      gap: 0.3rem;
    }

    /* TAGS / PILLS */
    .pill {
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 600;
      display: inline-block;
      white-space: nowrap;
    }
    .pill-restricted {
      background: rgba(220,38,38,0.12);
      color: var(--osmak-red);
    }
    .pill-monitored {
      background: rgba(16,185,129,0.12);
      color: #047857;
    }
    .pill-ids {
      background: rgba(245,158,11,0.16);
      color: var(--amber-dark);
      border: 1px solid var(--amber);
    }
    .pill-status-rej {
      background: rgba(220,38,38,0.16);
      color: var(--osmak-red);
    }
    .pill-status-app {
      background: rgba(0,154,62,0.16);
      color: var(--osmak-green-dark);
    }

    /* BUTTONS */
    .actions {
      margin-top: 0.55rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
    }
    .btn {
      border: none;
      border-radius: 0.4rem;
      padding: 0.4rem 0.75rem;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .btn-approve {
      background: var(--osmak-green);
      color: #fff;
    }
    .btn-reject {
      background: var(--osmak-red);
      color: #fff;
    }
    .btn-delete {
      background: #6b7280;
      color: #fff;
    }

    /* MODALS */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.45);
      z-index: 200;
    }
    .modal-box {
      background: #fff;
      border-radius: 0.75rem;
      width: 90%;
      max-width: 720px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 18px 36px rgba(0,0,0,0.25);
    }
    .modal-header {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-body {
      padding: 1rem;
      font-size: 0.9rem;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
    }

    .modal-body input,
    .modal-body select,
    .modal-body textarea {
      width: 100%;
      padding: 0.5rem;
      border-radius: 0.4rem;
      border: 1px solid var(--border);
      font-size: 0.9rem;
      margin: 0.4rem 0;
    }

    .modal-actions {
      margin-top: 0.7rem;
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    /* LOADING OVERLAY */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.6);
      display: none;
      align-items: flex-start;
      justify-content: flex-end;
      padding: 0.75rem;
      z-index: 150;
      pointer-events: none;
    }
    .loading-pill {
      background: #111827;
      color: #f9fafb;
      padding: 0.3rem 0.8rem;
      border-radius: 999px;
      font-size: 0.78rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }

    /* MOBILE TWEAKS */
    @media(max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .tabs {
        gap: 0.35rem;
      }
      .tab-btn {
        flex: 1 1 calc(50% - 0.35rem);
        text-align: center;
      }
      .list-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .list-right {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
<div id="loginScreen" style="
  position:fixed; inset:0; background:#f5f5f5; z-index:9999;
  display:flex; align-items:center; justify-content:center;
  font-family: system-ui, sans-serif;
">
  <div style="background:white; padding:2rem; border-radius:1rem; width:90%; max-width:380px; box-shadow:0 4px 16px rgba(0,0,0,0.15);">
    <h2 style="margin:0 0 1rem; font-size:1.25rem; text-align:center;">IDS Login</h2>

    <label style="font-size:.9rem;">Select IDS Specialist</label>
    <select id="loginIdsSelect" style="width:100%; padding:.5rem; margin:.4rem 0 1rem; border:1px solid #ccc; border-radius:.4rem;">
      <option value="">– Select –</option>
      <option>Dr. Christoper John Tibayan</option>
      <option>Dr. Paulo Garcia</option>
      <option>Dr. Jelly Ann Gozun-Recuenco</option>
      <option>Dr. Michelle Carandang-Cuvin</option>
      <option>Dr. Pia Catrina Tolentino Torres</option>
    </select>

    <label style="font-size:.9rem;">Enter PIN</label>
    <input type="password" id="loginPin" maxlength="4"
      style="width:100%; padding:.5rem; margin:.4rem 0 1rem;
      border:1px solid #ccc; border-radius:.4rem;" placeholder="1234">

    <button id="loginBtn" style="
      width:100%; padding:.6rem; background:#009a3e; color:white;
      font-size:.95rem; border:none; border-radius:.4rem; cursor:pointer;">
      Login
    </button>
  </div>
</div>

<header>
  <img src="https://maxterrenal-hash.github.io/justculture/osmak-logo.png" alt="OsMak Logo">
  <div>
    <h1>OSPITAL NG MAKATI</h1>
    <small>Antimicrobial Request System – IDS Module</small>
  </div>

<button id="logoutBtn" style="
  margin-left:auto;
  background:#dc2626;
  color:white;
  border:none;
  padding:0.35rem 0.8rem;
  border-radius:0.4rem;
  cursor:pointer;
  font-size:0.8rem;
">
  Logout
</button>

</header>

<div class="main">
  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="pending">Pending Restricted</button>
    <button class="tab-btn" data-tab="approvedRestricted">Approved Restricted</button>
    <button class="tab-btn" data-tab="rejectedRestricted">Rejected Restricted</button>
    <button class="tab-btn" data-tab="approvedMonitored">Approved Monitored</button>
    <button class="tab-btn" data-tab="rejectedMonitored">Rejected Monitored</button>
  </div>

  <!-- PENDING RESTRICTED -->
  <section class="section active" id="pending">
    <div class="filter-row">
      <select id="pendingIdsFilter">
        <option value="">All IDS</option>
        <option>Dr. Christoper John Tibayan</option>
        <option>Dr. Paulo Garcia</option>
        <option>Dr. Jelly Ann Gozun-Recuenco</option>
        <option>Dr. Michelle Carandang-Cuvin</option>
      </select>
    </div>

    <div id="pendingList"></div>
  </section>

  <!-- APPROVED RESTRICTED -->
  <section class="section" id="approvedRestricted">
<div class="filter-row">
  <input type="date" id="approvedRestrictedFrom">
  <input type="date" id="approvedRestrictedTo">
  <select id="approvedRestrictedIdsFilter">
        <option value="">All IDS</option>
        <option>Dr. Christoper John Tibayan</option>
        <option>Dr. Paulo Garcia</option>
        <option>Dr. Jelly Ann Gozun-Recuenco</option>
        <option>Dr. Michelle Carandang-Cuvin</option>
      </select>
    </div>
    <div class="list-container" id="approvedRestrictedList"></div>
  </section>

  <!-- REJECTED RESTRICTED -->
  <section class="section" id="rejectedRestricted">
<div class="filter-row">
  <input type="date" id="rejectedRestrictedFrom">
  <input type="date" id="rejectedRestrictedTo">
      <select id="rejectedRestrictedIdsFilter">
        <option value="">All IDS</option>
        <option>Dr. Christoper John Tibayan</option>
        <option>Dr. Paulo Garcia</option>
        <option>Dr. Jelly Ann Gozun-Recuenco</option>
        <option>Dr. Michelle Carandang-Cuvin</option>
      </select>
    </div>
    <div class="list-container" id="rejectedRestrictedList"></div>
  </section>

  <!-- APPROVED MONITORED -->
  <section class="section" id="approvedMonitored">
    <div class="filter-row">
<input type="date" id="approvedMonitoredFrom">
<input type="date" id="approvedMonitoredTo">
      <input type="text" id="approvedMonitoredPharm" placeholder="Filter by Pharmacist">
    </div>
    <div class="list-container" id="approvedMonitoredList"></div>
  </section>

  <!-- REJECTED MONITORED -->
  <section class="section" id="rejectedMonitored">
    <div class="filter-row">
<input type="date" id="rejectedMonitoredFrom">
<input type="date" id="rejectedMonitoredTo">
      <input type="text" id="rejectedMonitoredPharm" placeholder="Filter by Pharmacist">
    </div>
    <div class="list-container" id="rejectedMonitoredList"></div>
  </section>
</div>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-pill">Updating…</div>
</div>

<!-- DETAILS MODAL (FULL PHARMACY VERSION) -->
<div class="modal-backdrop" id="detailsBackdrop">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Request Details</h3>
      <button class="close-btn" id="detailsClose">✕</button>
    </div>
    <div class="modal-body" id="detailsBody"></div>
  </div>
</div>

<!-- PIN MODAL -->
<div class="modal-backdrop" id="pinBackdrop">
  <div class="modal-box" style="max-width:420px;">
    <div class="modal-header">
      <h3>Enter IDS PIN</h3>
      <button class="close-btn" id="pinClose">✕</button>
    </div>
    <div class="modal-body">
      <p style="font-size:0.85rem; color:var(--text-muted); margin-top:0;">
        Please enter your IDS approval PIN to proceed.
      </p>
      <input type="password" id="pinInput" placeholder="PIN" maxlength="10">
      <div class="modal-actions">
        <button class="btn btn-delete" id="pinCancel">Cancel</button>
        <button class="btn btn-approve" id="pinSubmit">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- REJECTION REASON (FULL PHARMACY VERSION) -->
<div class="modal-backdrop" id="reasonBackdrop">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Disapproval Reason</h3>
      <button class="close-btn" id="reasonClose">✕</button>
    </div>
    <div class="modal-body">

<select id="rejectReason" style="width:100%; padding:0.5rem;">
  <option>No infection</option>
  <option>Wrong choice</option>
  <option>Wrong dose</option>
  <option>Wrong route</option>
  <option>Wrong duration</option>
  <option>Others (specify)</option>
</select>

<input type="text" id="rejectReasonOther" placeholder="Specify..." 
       style="width:100%; margin-top:0.7rem; padding:0.5rem; display:none;">

<textarea id="rejectReasonNotes"
          placeholder="Add detailed notes here..."
          style="width:100%; height:120px; margin-top:0.7rem; padding:0.5rem; resize:vertical;"></textarea>

      <button class="btn approve" id="rejectSubmit">Submit</button>
      <button class="btn reject" id="rejectCancel">Cancel</button>
    </div>
  </div>
</div>

</div>

<script>
  // ==============================
  // CONFIG
  // ==============================
  const API = "https://script.google.com/macros/s/AKfycbwONf1cXzlTDOOHBcuo0j0us-bb074G_UBXytkGHNp3IpUChWwqUWSjq3TVV264fLac/exec";

  let ALL_DATA = [];
  let pinCallback = null;         // function(pin) { ... }
  let pendingRejectFileId = null;
  let pendingRejectReason = null;

// ==============================
// IDS LOGIN SYSTEM
// ==============================
const IDS_PINS = {
  "Dr. Christoper John Tibayan": "1987",
  "Dr. Paulo Garcia": "1988",
  "Dr. Jelly Ann Gozun-Recuenco": "1986",
  "Dr. Michelle Carandang-Cuvin": "1978",
  "Dr. Pia Catrina Tolentino Torres": "1979"
};

let LOGGED_IDS = null;

// Restore session if exists 
window.addEventListener("load", () => {
  const saved = localStorage.getItem("idsLogged");
  if (saved) {
    LOGGED_IDS = saved;
    finalizeLogin();
  }
});

// Login button handler
document.getElementById("loginBtn").onclick = () => {
  const name = document.getElementById("loginIdsSelect").value;
  const pin = document.getElementById("loginPin").value.trim();

  if (!name) return alert("Select your IDS name.");
if (!IDS_PINS[name] || pin !== IDS_PINS[name]) {
  alert("Invalid PIN.");
  return;
}

  LOGGED_IDS = name;
  localStorage.setItem("idsLogged", name);
  finalizeLogin();
};

function finalizeLogin() {
  document.getElementById("loginScreen").style.display = "none";

  // Auto-set filters for ALL tabs
  const idsSelectIds = [
    "pendingIdsFilter",
    "approvedRestrictedIdsFilter",
    "rejectedRestrictedIdsFilter"
  ];

  idsSelectIds.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = LOGGED_IDS;
    el.disabled = true;   // lock to this IDS
  });

  // After login → load data & apply filters
  loadData();
}

  // ==============================
// LOGOUT
// ==============================
document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("idsLogged");
  LOGGED_IDS = null;

  // Reset filters
  const idsSelectIds = [
    "pendingIdsFilter",
    "approvedRestrictedIdsFilter",
    "rejectedRestrictedIdsFilter"
  ];

  idsSelectIds.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.disabled = false;
    el.value = "";
  });

  // Show login screen again
  document.getElementById("loginScreen").style.display = "flex";
};

  // ==============================
  // LOADING OVERLAY
  // ==============================
  function showLoading() {
    document.getElementById("loadingOverlay").style.display = "flex";
  }
  function hideLoading() {
    document.getElementById("loadingOverlay").style.display = "none";
  }

  // ==============================
  // FETCH DATA
  // ==============================
  async function loadData() {
    showLoading();
    try {
      const res = await fetch(API);
      const json = await res.json();
      ALL_DATA = json.entries || [];
      setDefaultDates();
      renderAll();
    } catch (err) {
      console.error("IDS fetch error:", err);
      alert("Unable to load IDS data.");
    }
    hideLoading();
  }

function setDefaultDates() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, "0");
  const dd = String(today.getDate()).padStart(2, "0");

  const firstOfMonth = `${yyyy}-${mm}-01`;
  const todayStr = `${yyyy}-${mm}-${dd}`;

  const dateRanges = [
    ["approvedRestrictedFrom", "approvedRestrictedTo"],
    ["rejectedRestrictedFrom", "rejectedRestrictedTo"],
    ["approvedMonitoredFrom", "approvedMonitoredTo"],
    ["rejectedMonitoredFrom", "rejectedMonitoredTo"]
  ];

  dateRanges.forEach(([fromId, toId]) => {
    const fromEl = document.getElementById(fromId);
    const toEl = document.getElementById(toId);

    if (fromEl && !fromEl.value) fromEl.value = firstOfMonth;
    if (toEl && !toEl.value) toEl.value = todayStr;
  });
}

  // ==============================
  // MODALS – HELPERS
  // ==============================
function openDetails(entry) {
  const d = entry.data;
  const box = document.getElementById("detailsBody");

  // Normalized values (fix undefined)
  const patientName = d.patientName || d.patientname || "—";
  const age = d.age || "—";
  const sex = d.sex || "—";
  const hospitalNumber = d.hospitalNumber || d.hospitalnumber || "—";
  const ward = d.ward || "—";

  const weight = d.weightKg || d.weightkg || d.weight || "—";
  const height = d.heightCm || d.heightcm || d.height || "—";

  const diagnosis = d.diagnosis || "—";
  const indication = d.indication || "—";
  const basis = d.basisforindication || d.basisForIndication || "—";

  const resident = d.residentName || d.residentname || "—";
  const serviceResident = d.serviceResidentName || d.serviceresidentname || "—";
  const idsSpecialist = d.idSpecialist || d.infectiousdiseasespecialist || "—";

  const scr =
    d["scrmg/dl"] ||
    d.scrmgdl ||
    d.scrMgDl ||
    d.scr ||
    "—";

  const egfr =
    d.egfr ||
    d.egfrtext ||
    d.eGFR ||
    d.egfrText ||
    "—";

  const reqDate = d.reqDate || d.date || d.reqdate || "—";

  const drug = d.antimicrobial || "—";
  const dose = d.dose || "—";
  const freq = d.frequency || "—";
  const duration = d.duration || "—";

  const status = d.status || "—";

  let html = `
    <p><strong>Date:</strong> ${reqDate}</p>
    <hr>

    <p><strong>Name:</strong> ${patientName}</p>
    <p><strong>Age/Sex:</strong> ${age} y, ${sex}</p>
    <p><strong>Hospital #:</strong> ${hospitalNumber}</p>
    <p><strong>Ward:</strong> ${ward}</p>
    <p><strong>Weight:</strong> ${weight} kg</p>
    <p><strong>Height:</strong> ${height} cm</p>
    <hr>

    <p><strong>Serum Creatinine:</strong> ${scr}</p>
    <p><strong>eGFR:</strong> ${egfr}</p>
    <hr>

    <p><strong>Drug:</strong> ${drug}</p>
    <p><strong>Dose:</strong> ${dose}</p>
    <p><strong>Frequency:</strong> ${freq}</p>
    <p><strong>Duration:</strong> ${duration}</p>
    <hr>

    <p><strong>Diagnosis:</strong> ${diagnosis}</p>
    <p><strong>Indication:</strong> ${indication}</p>
    <p><strong>Basis for Indication:</strong> ${basis}</p>
    <hr>

    <p><strong>Resident:</strong> ${resident}</p>
    <p><strong>Service Resident:</strong> ${serviceResident}</p>
    <p><strong>IDS Specialist:</strong> ${idsSpecialist}</p>
    <p><strong>Status:</strong> ${status}</p>
    <hr>
  `;

  box.innerHTML = html;
  document.getElementById("detailsBackdrop").style.display = "flex";
}




  function openPinModal(callback) {
    pinCallback = callback;
    document.getElementById("pinInput").value = "";
    document.getElementById("pinBackdrop").style.display = "flex";
    setTimeout(() => document.getElementById("pinInput").focus(), 50);
  }
  function closePinModal() {
    pinCallback = null;
    document.getElementById("pinBackdrop").style.display = "none";
  }

  document.getElementById("pinCancel").onclick =
  document.getElementById("pinClose").onclick = () => {
    closePinModal();
  };

  document.getElementById("pinSubmit").onclick = () => {
    const pin = document.getElementById("pinInput").value.trim();
    if (!pin) {
      alert("PIN is required.");
      return;
    }
    if (pinCallback) pinCallback(pin);
    closePinModal();
  };

  // Reject Reason Modal
  const rejectReasonEl = document.getElementById("rejectReason");
  const rejectOtherEl = document.getElementById("rejectReasonOther");

  rejectReasonEl.onchange = () => {
    if (rejectReasonEl.value === "Others (specify)") {
      rejectOtherEl.style.display = "block";
    } else {
      rejectOtherEl.style.display = "none";
      rejectOtherEl.value = "";
    }
  };

  function openReasonModal(fileId) {
    pendingRejectFileId = fileId;
    pendingRejectReason = null;
    rejectReasonEl.value = "No infection";
    rejectOtherEl.style.display = "none";
    rejectOtherEl.value = "";
    document.getElementById("reasonBackdrop").style.display = "flex";
  }

  function closeReasonModal() {
    pendingRejectFileId = null;
    pendingRejectReason = null;
    document.getElementById("reasonBackdrop").style.display = "none";
  }

  document.getElementById("rejectCancel").onclick =
  document.getElementById("reasonClose").onclick = () => {
    closeReasonModal();
  };

  document.getElementById("rejectSubmit").onclick = () => {
    if (!pendingRejectFileId) {
      closeReasonModal();
      return;
    }
    let reason = rejectReasonEl.value;
    if (reason === "Others (specify)") {
      const other = rejectOtherEl.value.trim();
      if (!other) {
        alert("Please specify a reason.");
        return;
      }
      reason = other;
    }
    pendingRejectReason = reason;
    document.getElementById("reasonBackdrop").style.display = "none";

    openPinModal(async (pin) => {
      await updateStatus(pendingRejectFileId, "disapproved", pendingRejectReason, pin);
      pendingRejectFileId = null;
      pendingRejectReason = null;
    });
  };

    // ==============================
  // IDS ACTION HELPERS (API CALLS)
  // ==============================
  async function updateStatus(fileId, status, reason, pin) {
    try {
      showLoading();
      const body = {
        action: "idsUpdateStatus",
        fileId,
        status,
        pin
      };
      if (status === "disapproved" && reason) {
        body.reason = reason;
      }

      const res = await fetch(API, {
        method: "POST",
        body: JSON.stringify(body)
      });
      const json = await res.json().catch(() => ({}));
      if (!json.ok) {
        alert(json.error || "Update failed.");
      }
      await loadData();
    } catch (err) {
      console.error("updateStatus error:", err);
      alert("Error updating request.");
    } finally {
      hideLoading();
    }
  }

  async function deleteEntry(fileId, pin) {
    try {
      showLoading();
      const res = await fetch(API, {
        method: "POST",
        body: JSON.stringify({
          action: "idsDeleteEntry",
          fileId,
          pin
        })
      });
      const json = await res.json().catch(() => ({}));
      if (!json.ok) {
        alert(json.error || "Delete failed.");
      }
      await loadData();
    } catch (err) {
      console.error("idsDeleteEntry error:", err);
      alert("Error deleting entry.");
    } finally {
      hideLoading();
    }
  }

  // ==============================
  // RENDER HELPERS
  // ==============================
  function renderPending() {
    const idsFilter = document.getElementById("pendingIdsFilter").value.trim();
    const container = document.getElementById("pendingList");
    container.innerHTML = "";

    const filtered = ALL_DATA.filter((e) => {
      const d = e.data;
      if (!d) return false;

      // Only restricted entries
      if (d.drugType !== "Restricted") return false;

      // Only entries waiting for IDS
      if (d.status !== "for_ids_approval") return false;

      // Filter by IDS name (if selected)
      const activeIDS = LOGGED_IDS || idsFilter;
      if (activeIDS && d.idSpecialist !== activeIDS) return false;

      return true;
    });

    if (!filtered.length) {
      container.innerHTML = `
        <div class="card" style="cursor:default;">
          <div class="card-body-line" style="color:var(--text-muted);">No pending restricted entries.</div>
        </div>`;
      return;
    }

    filtered.forEach((entry) => {
      const d = entry.data;

      const card = document.createElement("div");
      card.className = "card";
card.innerHTML = `
  <div class="card-header">
    <div class="card-title">${d.patientName || "Unnamed Patient"}</div>
    <span class="pill pill-restricted">Restricted</span>
  </div>

  <div class="card-body-line">
    <strong>Drug:</strong> ${d.antimicrobial || ""}  
    ${d.dose ? `(${d.dose}` : ""}${d.frequency ? ` × ${d.frequency})` : d.dose ? ")" : ""}
  </div>

  <div class="card-body-line"><strong>Service Resident:</strong> ${d.serviceResidentName || d.serviceresidentname || "—"}</div>

  <div class="card-body-line"><strong>Date:</strong> ${d.reqDate || "—"}</div>

  <div class="card-body-line">
    <span class="pill pill-ids">${d.idSpecialist || "No IDS Assigned"}</span>
  </div>

  <div class="actions">
    <button class="btn btn-approve btn-approve-ids">Approve</button>
    <button class="btn btn-reject btn-reject-ids">Disapprove</button>
  </div>
`;

      // Clicking the card opens full details
      card.onclick = (ev) => {
        if (ev.target.closest("button")) return;
        openDetails(entry);
      };

      // Approve -> PIN → idsUpdateStatus(..., "approved")
      card.querySelector(".btn-approve-ids").onclick = (ev) => {
        ev.stopPropagation();
        openPinModal(async (pin) => {
          await updateStatus(entry.fileId, "approved", null, pin);
        });
      };

      // Disapprove -> Reason → PIN → idsUpdateStatus(..., "disapproved")
      card.querySelector(".btn-reject-ids").onclick = (ev) => {
        ev.stopPropagation();
        openReasonModal(entry.fileId);
      };

      container.appendChild(card);
    });
  }

function renderRestrictedList({ listId, fromId, toId, idsFilterId, status, allowApprove, allowDelete }) {
  const container = document.getElementById(listId);
  container.innerHTML = "";

  const from = document.getElementById(fromId)?.value;
  const to = document.getElementById(toId)?.value;
  const idsFilter = document.getElementById(idsFilterId)?.value;

  const filtered = ALL_DATA.filter(e => {
    const d = e.data;
    if (!d) return false;
    if (d.drugType !== "Restricted") return false;
    if (d.status !== status) return false;

    if (from && d.reqDate < from) return false;
    if (to && d.reqDate > to) return false;

const activeIDS = LOGGED_IDS || idsFilter;
if (activeIDS && d.idSpecialist !== activeIDS) return false;

    return true;
  });


    if (!filtered.length) {
      container.innerHTML = `<div class="list-item" style="cursor:default;"><div style="font-size:0.85rem; color:var(--text-muted);">No entries for this filter.</div></div>`;
      return;
    }

    filtered.forEach(entry => {
      const d = entry.data;
      const row = document.createElement("div");
      row.className = "list-item";

      const left = document.createElement("div");
      left.className = "list-left";
      left.innerHTML = `
        <strong>${d.patientName || "Unnamed Patient"}</strong><br>
        ${d.ward || ""} – ${d.antimicrobial || ""}<br>
        <span style="color:var(--text-muted); font-size:0.8rem;">${d.indication || ""}</span><br>
        <span class="pill pill-restricted">Restricted</span>
        <span class="pill pill-ids">${d.idSpecialist || ""}</span>
      `;

      const right = document.createElement("div");
      right.className = "list-right";
      right.innerHTML = `
        <span style="color:var(--text-muted);">${d.reqDate || ""}</span>
        <div>
          ${
            status === "approved"
              ? `<span class="pill pill-status-app">Approved</span>`
              : `<span class="pill pill-status-rej">Rejected</span>`
          }
        </div>
      `;

      const btnBar = document.createElement("div");
      btnBar.style.display = "flex";
      btnBar.style.gap = "0.35rem";
      btnBar.style.marginTop = "0.45rem";

      // From Rejected → Approve (back to approved)
      if (allowApprove) {
        const approveBtn = document.createElement("button");
        approveBtn.className = "btn btn-approve";
        approveBtn.textContent = "Approve";
        approveBtn.onclick = (ev) => {
          ev.stopPropagation();
          openDetails(entry);
          openPinModal(async (pin) => {
            await updateStatus(entry.fileId, "approved", null, pin);
          });
        };
        btnBar.appendChild(approveBtn);
      }

      // From Approved → Disapprove
      if (status === "approved") {
        const disBtn = document.createElement("button");
        disBtn.className = "btn btn-reject";
        disBtn.textContent = "Disapprove";
        disBtn.onclick = (ev) => {
          ev.stopPropagation();
          openDetails(entry);
          openReasonModal(entry.fileId);
        };
        btnBar.appendChild(disBtn);
      }

      if (allowDelete) {
        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-delete";
        delBtn.textContent = "Delete";
        delBtn.onclick = (ev) => {
          ev.stopPropagation();
          if (!confirm("Delete this IDS record?")) return;
          openPinModal(async (pin) => {
            await deleteEntry(entry.fileId, pin);
          });
        };
        btnBar.appendChild(delBtn);
      }

      right.appendChild(btnBar);

      row.appendChild(left);
      row.appendChild(right);

      row.onclick = () => openDetails(entry);

      container.appendChild(row);
    });
  }

function renderMonitoredList({ listId, fromId, toId, pharmId, status }) {
  const container = document.getElementById(listId);
  container.innerHTML = "";

  const from = document.getElementById(fromId)?.value;
  const to = document.getElementById(toId)?.value;
  const pharmFilter = document.getElementById(pharmId)?.value.trim().toLowerCase();

  const filtered = ALL_DATA.filter(e => {
    const d = e.data;
    if (!d) return false;
    if (d.drugType !== "Monitored") return false;
    if (d.status !== status) return false;

    if (from && d.reqDate < from) return false;
    if (to && d.reqDate > to) return false;

    if (pharmFilter) {
      const pharmacist = (d.dispensedBy || "").toLowerCase();
      if (!pharmacist.includes(pharmFilter)) return false;
    }

    return true;
  });

    if (!filtered.length) {
      container.innerHTML = `<div class="list-item" style="cursor:default;"><div style="font-size:0.85rem; color:var(--text-muted);">No monitored entries for this filter.</div></div>`;
      return;
    }

    filtered.forEach(entry => {
      const d = entry.data;
      const row = document.createElement("div");
      row.className = "list-item";

      const left = document.createElement("div");
      left.className = "list-left";
      left.innerHTML = `
        <strong>${d.patientName || "Unnamed Patient"}</strong><br>
        ${d.ward || ""} – ${d.antimicrobial || ""}<br>
        <span style="color:var(--text-muted); font-size:0.8rem;">${d.indication || ""}</span><br>
        <span class="pill pill-monitored">Monitored</span>
      `;

      const right = document.createElement("div");
      right.className = "list-right";
      right.innerHTML = `
        <span style="color:var(--text-muted);">${d.reqDate || ""}</span>
        ${
          d.dispensedBy
            ? `<span style="font-size:0.78rem; color:var(--text-muted);">Pharmacist: ${d.dispensedBy}</span>`
            : ""
        }
        <span class="pill ${
          status === "approved" ? "pill-status-app" : "pill-status-rej"
        }">${status === "approved" ? "Approved" : "Rejected"}</span>
      `;

      row.appendChild(left);
      row.appendChild(right);
      row.onclick = () => openDetails(entry);

      container.appendChild(row);
    });
  }

function renderAll() {
  renderPending();

  renderRestrictedList({
    listId: "approvedRestrictedList",
    fromId: "approvedRestrictedFrom",
    toId: "approvedRestrictedTo",
    idsFilterId: "approvedRestrictedIdsFilter",
    status: "approved",
    allowApprove: false,
    allowDelete: true
  });

  renderRestrictedList({
    listId: "rejectedRestrictedList",
    fromId: "rejectedRestrictedFrom",
    toId: "rejectedRestrictedTo",
    idsFilterId: "rejectedRestrictedIdsFilter",
    status: "disapproved",
    allowApprove: true,
    allowDelete: true
  });

  renderMonitoredList({
    listId: "approvedMonitoredList",
    fromId: "approvedMonitoredFrom",
    toId: "approvedMonitoredTo",
    pharmId: "approvedMonitoredPharm",
    status: "approved"
  });

  renderMonitoredList({
    listId: "rejectedMonitoredList",
    fromId: "rejectedMonitoredFrom",
    toId: "rejectedMonitoredTo",
    pharmId: "rejectedMonitoredPharm",
    status: "disapproved"
  });
}


  // ==============================
  // TAB SWITCHING
  // ==============================
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const tab = btn.dataset.tab;
      document.querySelectorAll(".section").forEach(sec => {
        sec.classList.remove("active");
      });
      document.getElementById(tab).classList.add("active");
    });
  });

  // ==============================
  // FILTER CHANGE → RE-RENDER
  // ==============================
  [
  "pendingIdsFilter",

  "approvedRestrictedFrom", "approvedRestrictedTo", "approvedRestrictedIdsFilter",
  "rejectedRestrictedFrom", "rejectedRestrictedTo", "rejectedRestrictedIdsFilter",

  "approvedMonitoredFrom", "approvedMonitoredTo", "approvedMonitoredPharm",
  "rejectedMonitoredFrom", "rejectedMonitoredTo", "rejectedMonitoredPharm"
]
.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("change", renderAll);
    el.addEventListener("input", renderAll);
  });

// ==============================
// DETAILS MODAL — CLOSE BEHAVIOR
// (copied from Pharmacy module)
// ==============================
document.getElementById("detailsClose").onclick = () => {
  document.getElementById("detailsBackdrop").style.display = "none";
};

document.getElementById("detailsBackdrop").onclick = (ev) => {
  if (ev.target === document.getElementById("detailsBackdrop")) {
    document.getElementById("detailsBackdrop").style.display = "none";
  }
};

  
  // ==============================
  // INIT
  // ==============================
window.addEventListener("load", loadData);
</script>

</body>
</html>
